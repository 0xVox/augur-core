<!doctype html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<html lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
<title>Augur</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <!--//-->
<link rel="stylesheet" href="static/google-fonts.css" />
<link rel="stylesheet" href="static/bootstrap.css" />
<link rel="stylesheet" href="static/font-awesome.min.css" />
<link rel="stylesheet" href="static/augur.css" />
<script src="static/jquery.min.js"></script>
<script src="static/bootstrap.min.js"></script>
<script src="static/lodash.js"></script>
<script src="static/socket.io.min.js"></script>

<script src="static/bignumber.js"></script>
<script src="static/es6-promise.js"></script>
<script src="static/ethereum.js"></script>
<script type="text/javascript">
    var web3 = require('web3');
    var ethsocket = "ws://127.0.0.1:40404/eth";

    web3.setProvider(new web3.providers.WebSocketProvider(ethsocket));

    // test websocket connection
    // web3.sha3(web3.fromAscii("hello world"));

    // solidity source code
    var source = "" + 
    "contract test {\n" +
    "   function multiply(uint a) returns(uint d) {\n" +
    "       return a * 7;\n" +
    "   }\n" +
    "}\n";

    // contract description, this will be autogenerated somehow
    var desc =  [{
        "name": "multiply",
        "inputs": [{
            "name": "a",
            "type": "uint256"
        }],
        "outputs": [{
            "name": "d",
            "type": "uint256"
        }]
    }];

    var contract;

    function createExampleContract() {
        // hide create button
        document.getElementById('create').style.visibility = 'hidden'; 
        document.getElementById('source').innerText = source;
        // create contract
        web3.eth.transact({code: web3.eth.solidity(source)}).then(function (address) {
            contract = web3.contract(address, desc);
            document.getElementById('call').style.visibility = 'visible';
        });
    }

    function callExampleContract() {
        // this should be generated by ethereum
        var param = parseInt(document.getElementById('value').value);
        // call the contract
        contract.multiply(param).call().then(function(res) {
            document.getElementById('result').innerText = res[0];
        });
    }

    web3.eth.watch({altered: web3.eth.coinbase}).changed(function () {
        web3.eth.coinbase.then(function (result) {
            document.getElementById('coinbase').innerText = result;
        });
        web3.eth.balanceAt(web3.eth.coinbase).then(function (result) {
            document.getElementById('balance').innerText = result;
        });
    });

    document.getElementById('balance').innerText = web3.toDecimal(result);

    web3.eth.watch().changed(function () {
        web3.eth.block(web3.eth.number).then(function (result) {
            document.getElementById('latestBlock').innerText = web3.eth.number._result;
            document.getElementById('latestBlockHash').innerText = result.hash;
            document.getElementById('latestBlockTimestamp').innerText = Date(result.timestamp);
        });
    });
</script>
</head>
<body class="stopped">
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <h1 class="navbar-brand"><span>·∏Åugur</span></h1>
            </div>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <button class="btn btn-sm miner-control" style="display: none;">
                        <span class="status"></span>
                        <i class="glyphicon glyphicon-off"></i>
                    </button>
                </li>
                <li>
                    <button class="btn btn-sm node-settings" style="display: none;" data-toggle="modal" data-target="#node-settings-modal">
                        <span class="status"></span>
                        <i class="glyphicon glyphicon-cog"></i>
                    </button>
                </li>
            </ul>
        </div>
        <script type="text/template" id="parsing-template">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="<%= percent %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= percent %>%;">
            </div>
        </script>
        <div class="parsing progress"></div>
    </nav>

    <section id="main" class="container">
        <h1>contract</h1>
        <div id="source"></div> 
        <div id='create'>
            <button type="button" onClick="createExampleContract();">create example contract</button>
        </div>
        <div id='call' style='visibility: hidden;'>
            <input type="number" id="value" onkeyup='callExampleContract()'></input>
        </div>
        <div id="result"></div>
    </section>

    <footer>
        <div class="row container clearfix"></div>
    </footer>
</body>
</html>

macro multiply($aflat, $arows, $acols, $bflat, $brows, $bcols):
    with a = array($arows):
        with i = 0:
            while i < $arows:
                a[i] = array($acols)
                with j = 0:
                    while j < $acols:
                        a[i][j] = $aflat[j + i*$acols]
                        j += 1
                i += 1
        with b = array($brows):
            with i = 0:
                while i < $brows:
                    b[i] = array($bcols)
                    with j = 0:
                        while j < $bcols:
                            b[i][j] = $bflat[j + i*$bcols]
                            j += 1
                    i += 1
            with c = array($arows):
                if $bcols > 1:
                    with i = 0:
                        while i < $arows:
                            c[i] = array($bcols)
                            i += 1
                with i = 0:
                    while i < $arows:
                        with j = 0:
                            while j < $bcols:
                                with k = 0:
                                    while k < $acols:
                                        if $bcols == 1:
                                            c[i] += a[i][k] * b[k]
                                        else:
                                            c[i][j] += a[i][k] * b[k][j]
                                        k += 1
                                j += 1
                        i += 1
                c

def test_multiply():
    # a = [[0, 0, 0, 1], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [1, 0, 0, 0], [0, 0, 0, 0]]
    # arows = 6
    # acols = 4
    # b = [[17475862806672206791, 0, 0, 0], [0, 5675921253449092804, 0, 0], [0, 0, 7094901566811366005, 0], [0, 0, 0, 6148914691236517204]]
    # brows = 4
    # bcols = 4
    a = [[1, 4], [2, 5], [3, 6]]
    arows = 3
    acols = 2
    b = [[1, 2, 3], [4, 5, 6]]
    brows = 2
    bcols = 3
    with aflat = array(arows * acols):
        with i = 0:
            while i < arows:
                with j = 0:
                    while j < acols:
                        aflat[j + i*acols] = a[i][j]
                        j += 1
                    i += 1
        with bflat = array(brows * bcols):
            with i = 0:
                while i < brows:
                    with j = 0:
                        while j < bcols:
                            bflat[j + i*bcols] = b[i][j]
                            j += 1
                        i += 1
            with expected = [[17, 22, 27], [22, 29, 36], [27, 36, 45]]:
                # expected = [[0, 0, 0, 0x5555555555555400], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0xf286bca1af286800, 0, 0, 0], [0, 0, 0, 0]]
                with actual = multiply(aflat, arows, acols, bflat, brows, bcols):
                    with i = 0:
                        while i < arows:
                            with j = 0:
                                while j < bcols:
                                    if expected[i][j] != actual[i][j]:
                                        return(0)
                                    j += 1
                                i += 1
                        return(1)
